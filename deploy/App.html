<!DOCTYPE html>
<html>
<head>
    <title>Estimation Board</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("RowSettingsField",{alias:"widget.rowsettingsfield",extend:"Ext.form.FieldContainer",requires:["Rally.ui.CheckboxField","Rally.ui.combobox.ComboBox","Rally.ui.plugin.FieldValidationUi","Rally.data.ModelFactory","Rally.data.wsapi.ModelBuilder"],mixins:{field:"Ext.form.field.Field"},layout:"hbox",cls:"row-settings",config:{value:void 0,isAllowedFieldFn:Ext.emptyFn,explicitFields:[],modelNames:["userstory","defect"],whiteListFields:[]},initComponent:function(){this.callParent(arguments),this.mixins.field.initField.call(this),this.add([{xtype:"rallycheckboxfield",name:"showRows",boxLabel:"",margin:"0",submitValue:!1,value:this.getValue().showRows,listeners:{change:function(checkbox,checked){this.down("rallycombobox").setDisabled(!checked)},scope:this}},{xtype:"rallycombobox",plugins:["rallyfieldvalidationui"],name:"rowsField",margin:"0 6px",width:130,emptyText:"Choose Field...",displayField:"name",valueField:"value",disabled:"true"!==this.getValue().showRows,editable:!1,submitValue:!1,storeType:"Ext.data.Store",storeConfig:{remoteFilter:!1,fields:["name","value"],data:[]}}]),this._loadModels()},_loadModels:function(){Rally.data.ModelFactory.getModels({types:this.getModelNames(),context:this.context,success:this._onModelsRetrieved,scope:this})},_onModelsRetrieved:function(models){var fields=_.uniq(Ext.Array.merge(this.explicitFields,this._getRowableFields(_.values(models))),"name"),combobox=this.down("rallycombobox");combobox.getStore().loadData(_.sortBy(fields,"name")),combobox.setValue(this.getValue().rowsField),this.fireEvent("ready",this)},_getRowableFields:function(models){var artifactModel=Rally.data.wsapi.ModelBuilder.buildCompositeArtifact(models,this.context),allFields=artifactModel.getFields(),rowableFields=_.filter(allFields,function(field){var attr=field.attributeDefinition;return attr&&!attr.Hidden&&attr.Sortable&&(artifactModel.getModelsForField(field).length===models.length&&this.isAllowedFieldFn(field)||_.contains(this.whiteListFields,field.displayName))},this);return _.map(rowableFields,function(field){return{name:field.displayName,value:field.name}})},getSubmitData:function(){var data={},showField=this.down("rallycheckboxfield"),rowsField=this.down("rallycombobox"),showRows=showField.getValue()&&!_.isEmpty(rowsField.getValue());return data[showField.name]=showRows,showRows&&(data[rowsField.name]=rowsField.getValue()),data},refreshWithNewModelType:function(type){this.setModelNames([type]),this._loadModels()}});
                Ext.define("Settings",{singleton:!0,requires:["Rally.ui.combobox.FieldComboBox","Rally.ui.combobox.ComboBox","Rally.ui.TextField","Rally.ui.NumberField","RowSettingsField","Rally.data.wsapi.Filter"],getFields:function(context){return[{name:"sizes",xtype:"rallytextfield",fieldLabel:"Sizes"},{name:"groupHorizontallyByField",xtype:"rowsettingsfield",fieldLabel:"Swimlanes",mapsToMultiplePreferenceKeys:["showRows","rowsField"],readyEvent:"ready",isAllowedFieldFn:function(field){var attr=field.attributeDefinition;return(attr.Custom&&(attr.Constrained||"string"!==attr.AttributeType.toLowerCase())||attr.Constrained||_.contains(["quantity","boolean"],attr.AttributeType.toLowerCase())||!attr.Constrained&&"object"===attr.AttributeType.toLowerCase())&&!_.contains(["web_link","text","date"],attr.AttributeType.toLowerCase())&&!_.contains(["PortfolioItemType","LastResult"],attr.ElementName)},handlesEvents:{typeselected:function(type,context){this.refreshWithNewModelType(type,context)}}},{type:"query"}]}});
                Ext.define("EstimationBoardApp",{extend:"Rally.app.App",alias:"widget.boardapp",requires:["Rally.ui.cardboard.plugin.FixedHeader","Rally.ui.gridboard.GridBoard","Rally.ui.gridboard.plugin.GridBoardAddNew","Rally.ui.gridboard.plugin.GridBoardCustomFilterControl","Rally.ui.gridboard.plugin.GridBoardFieldPicker","Rally.data.util.Sorter","Settings","Rally.clientmetrics.ClientMetricsRecordable"],mixins:["Rally.clientmetrics.ClientMetricsRecordable"],cls:"customboard",autoScroll:!1,layout:"fit",config:{defaultSettings:{types:["HierarchicalRequirement","Defect"],showRows:!1,sizes:"1,2,3,5,8"}},launch:function(){Rally.data.ModelFactory.getModels({types:this.getSetting("types"),context:this.getContext().getDataContext()}).then({success:function(models){this.models=models,this.add(this._getGridBoardConfig())},scope:this})},_getGridBoardConfig:function(){var context=this.getContext(),modelNames=this.getSetting("types"),config={xtype:"rallygridboard",stateful:!1,toggleState:"board",cardBoardConfig:this._getBoardConfig(),plugins:[{ptype:"rallygridboardaddnew",addNewControlConfig:{stateful:!0,stateId:context.getScopedStateId("board-add-new")}},{ptype:"rallygridboardcustomfiltercontrol",filterChildren:!1,filterControlConfig:{margin:"3 9 3 30",modelNames:modelNames,stateful:!0,stateId:context.getScopedStateId("board-custom-filter-button")},showOwnerFilter:!0,ownerFilterControlConfig:{stateful:!0,stateId:context.getScopedStateId("board-owner-filter")}},{ptype:"rallygridboardfieldpicker",headerPosition:"left",boardFieldBlackList:["Successors","Predecessors","DisplayColor"],modelNames:modelNames,boardFieldDefaults:["PlanEstimate"]}],context:context,modelNames:modelNames,storeConfig:{filters:this._getFilters()},listeners:{load:this._onLoad,scope:this}};return this.getEl()&&(config.height=this.getHeight()),config},_onLoad:function(){this.recordComponentReady({miscData:{type:this.getSetting("type"),columns:this.getSetting("groupByField"),rows:this.getSetting("showRows")&&this.getSetting("rowsField")||""}})},_getBoardConfig:function(){var boardConfig={margin:"10px 0 0 0",attribute:"PlanEstimate",context:this.getContext(),cardConfig:{editable:!0,showIconMenus:!0},loadMask:!0,plugins:[{ptype:"rallyfixedheadercardboard"}],storeConfig:{sorters:Rally.data.util.Sorter.sorters(this.getSetting("order"))},columnConfig:{columnHeaderConfig:{headerTpl:"{size}"}},columns:_.map([null].concat(this.getSetting("sizes").split(",")),function(size){return{value:size&&parseInt(size,10),columnHeaderConfig:{headerData:{size:size||"No Estimate"}}}})};return this.getSetting("showRows")&&Ext.merge(boardConfig,{rowConfig:{field:this.getSetting("rowsField"),sortDirection:"ASC"}}),this._shouldDisableRanking()&&(boardConfig.enableRanking=!1,boardConfig.enableCrossColumnRanking=!1,boardConfig.cardConfig.showRankMenuItems=!1),boardConfig},getSettingsFields:function(){return Settings.getFields(this.getContext())},_shouldDisableRanking:function(){return!this.getSetting("showRows")||this.getSetting("showRows")&&"workproduct"!==this.getSetting("rowsField").toLowerCase()},_addBoard:function(){var gridBoard=this.down("rallygridboard");gridBoard&&gridBoard.destroy(),this.add(this._getGridBoardConfig())},onTimeboxScopeChange:function(timeboxScope){this.callParent(arguments),this._addBoard()},_getFilters:function(){var queries=[],timeboxScope=this.getContext().getTimeboxScope();return this.getSetting("query")&&queries.push(Rally.data.QueryFilter.fromQueryString(this.getSetting("query"))),timeboxScope&&_.all(this.models,function(model){return model.hasField(Ext.String.capitalize(timeboxScope.getType()))})&&queries.push(timeboxScope.getQueryFilter()),queries}});

            Rally.launchApp('EstimationBoardApp', {
                name:"Estimation Board",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .customboard{overflow-y:hidden}
    </style>
</head>
<body>
</body>
</html>
